---
import YukinaConfig from "../../yukina.config";
import Logo from "../components/Logo.astro";
import { i18n } from "../locales/translation";
import { Icon } from "astro-icon/components";

// ⚠️ navCount doit compter les enfants pour la hauteur du menu mobile
const navCount = YukinaConfig.navigators.reduce(
  (acc: number, nav: any) => acc + 1 + ((nav.children?.length) ?? 0),
  0
);
---

<nav class="nav" id="nav">
  <div
    class="relative flex h-[4rem] w-full items-center justify-between overflow-visible lg:h-[4.5rem]"
  >
    <div class="brand after:content-['']">
      <button
        id="menu-switcher"
        type="button"
        class="h-[40px] w-[44px] content-center"
        aria-label="menu déroulant"
       
      >
        <Icon
          id="menu-icon-closed"
          size={24}
          name="line-md:close-to-menu-transition"
          class="mx-auto hidden"
        />
        <Icon
          id="menu-icon-opened"
          size={24}
          name="line-md:menu-to-close-transition"
          class="mx-auto hidden"
        />
      </button>
      <a class="title" href="/">
          <Logo text="ZFX"/>
      </a>
    </div>

    <a class="brand-lg" title="réparation , dépannage informatique et coaching digital" href="/">
      <div class="title space-x-2 brand-logo">
        <Logo text="ZFX"/>
      </div>
    </a>

    <!-- ======= DESKTOP MENU ======= -->
    <div class="menu">
      {
        YukinaConfig.navigators.map((nav) => (
          nav.children?.length ? (
            <div class="menu-group">
              <a href={nav.href} class="menu-parent">
                <p>{i18n(nav.nameKey)}</p>
                <Icon name="cuida:caret-down-outline" class="ml-1 text-[var(--text-color-lighten)]" />
              </a>
              <ul class="submenu" role="menu">
                {
                  nav.children.map((child) => (
                    <li>
                      <a class="submenu-link" href={child.href} role="menuitem">
                        {i18n(child.nameKey)}
                      </a>
                    </li>
                  ))
                }
              </ul>
            </div>
          ) : (
            <a href={nav.href} class="">
              <p>{i18n(nav.nameKey)}</p>
            </a>
          )
        ))
      }
    </div>

    <div class="toolbar">
      <div class="theme">
        <button type="button" id="theme-switcher" aria-label="changer le thème">
          <Icon
            id="theme-icon-light"
            name="line-md:moon-alt-to-sunny-outline-loop-transition"
            size={24}
            class="hidden"
          />
          <Icon
            id="theme-icon-dark"
            name="line-md:sunny-outline-to-moon-alt-loop-transition"
            size={24}
            class="hidden"
          />
        </button>
      </div>
    </div>
  </div>

  <!-- ======= MOBILE MENU ======= -->
  <div id="mobile-menu" class="px-3 transition-all">
  <ul
    id="mobile-menu-nav"
    class="mobile-menu-nav mobile-menu-nav-closed flex flex-col space-y-6 overflow-hidden text-xl font-medium text-[var(--text-color)] transition-all duration-300"
  >
    {
      YukinaConfig.navigators.map((nav) => (
        nav.children?.length ? (
          <li class="mt-1">
        
            <a href={nav.href} class="mobile-nav-item">
              <div class="flex flex-row items-center space-x-2">
                <span class="text-[var(--primary-color)]">·</span>
                <span>{i18n(nav.nameKey)}</span>
              </div>
              <Icon
                name="cuida:caret-right-outline"
                class="text-[var(--text-color-lighten)]"
              />
            </a>
            <ul class="mt-3 ml-6 space-y-4">
              {
                nav.children.map((child) => (
                  <li>
                    <!-- garder la classe mobile-nav-item pour fermer le menu au clic -->
                    <a href={child.href} class="mobile-nav-item flex flex-row items-center justify-between">
                      <div class="flex flex-row items-center space-x-2">
                        <span class="opacity-60">•</span>
                        <span>{i18n(child.nameKey)}</span>
                      </div>
                      <Icon name="cuida:caret-right-outline" class="text-[var(--text-color-lighten)]" />
                    </a>
                  </li>
                ))
              }
            </ul>
          </li>
        ) : (
          <li class="mt-1">
            <a href={nav.href} class="mobile-nav-item">
              <div class="flex flex-row items-center space-x-2">
                <span class="text-[var(--primary-color)]">·</span>
                <span>{i18n(nav.nameKey)}</span>
              </div>
              <Icon
                name="cuida:caret-right-outline"
                class="text-[var(--text-color-lighten)]"
              />
            </a>
          </li>
        )
      ))
    }
  </ul>
</div>

</nav>

<style define:vars={{ navCount }}>
  .nav {
    @apply fixed left-1/2 z-10 flex w-full select-none flex-col justify-end rounded-b-xl bg-[var(--card-color-transparent)] px-2.5 opacity-0 backdrop-blur-md transition-all;
    @apply lg:w-[var(--page-width-lg)] lg:rounded-b-2xl;
    @apply xl:w-[var(--page-width-xl)];
    transform: translateX(-50%) translateY(-5rem);
    animation: 300ms nav-onload-animation;
    animation-fill-mode: forwards;
  }

  .brand {
    @apply flex w-full flex-row items-center justify-between;
    @apply lg:hidden;
  }

  .brand > .title {
    @apply absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 truncate rounded-lg px-4 py-2 text-2xl font-medium text-[var(--primary-color)] transition-all;
    @apply hover:bg-[var(--primary-color-hover)];
    font-family: var(--brand-font);
  }

  .brand button {
    @apply mr-2 flex h-[44px] w-[44px] flex-row items-center rounded-lg text-[var(--text-color)] transition-all;
    @apply hover:bg-[var(--primary-color-hover)] hover:text-[var(--primary-color)];
  }

  .brand-lg {
    @apply hidden h-[3.25rem] rounded-lg px-5 font-medium transition-all;
    @apply lg:block;
 
    @apply active:scale-95;
  }

  .brand-lg > .title {
    @apply flex h-full flex-row content-center items-center text-2xl text-[var(--primary-color)];
    font-family: var(--brand-font);
  }

  .brand-lg .icon {
    @apply mr-2 stroke-2 text-2xl;
  }

  .menu {
    @apply absolute left-1/2 hidden -translate-x-1/2 items-center justify-between space-x-1 text-lg text-[var(--text-color)] opacity-85;
    @apply lg:flex;
  }

  /* Liens de niveau 1 */
  .menu a {
    @apply flex h-[3.25rem] items-center rounded-lg px-6 transition-all;
    @apply hover:bg-[var(--primary-color-hover)] hover:text-[var(--primary-color)];
    @apply active:scale-95;
  }
  .menu p { @apply font-medium leading-normal; font-family: var(--primary-font); }

  /* Groupe dropdown desktop */
  .menu-group { @apply relative; }
  .menu-parent { @apply flex items-center; }

/* remplace ton bloc existant */
.submenu {
  @apply absolute left-0 min-w-[12rem] rounded-lg border text-base;
border-color: #72a9ff;
  background: rgba(245, 245, 245, 0.98);
  box-shadow: 4px 8px 10px rgba(28, 110, 198, 0.47);
  display: none;
  z-index: 50;
  padding: .35rem 0;

  /* important : plus de marge verticale, on colle sous le parent */
  margin-top: 0;            /* <- enlève l’effet de mt-1 */
  top: calc(100% + 6px);    /* petit offset propre, sans créer de “trou” */
}

  .submenu .submenu-link {
    @apply block px-4 py-2 whitespace-nowrap transition-all;
  }
  .submenu .submenu-link:hover {
    @apply bg-[var(--primary-color-hover)] text-[var(--primary-color)];
  }
.menu-group { position: relative; }
.menu-group::after {
  content: "";
  position: absolute;
  left: 0; right: 0;
  top: 100%;
  height: 10px;           /* zone tampon invisible */
}
  /* Affichage au survol / focus */
  .menu-group:hover > .submenu,
  .menu-group:focus-within > .submenu { display: block; }

  .toolbar { @apply flex flex-row items-center justify-end space-x-1 lg:mr-2; }
  .toolbar button {
    @apply flex w-11 justify-center rounded-lg py-2 text-[var(--text-color)] transition-all;
    @apply hover:bg-[var(--primary-color-hover)] hover:text-[var(--primary-color)];
  }
  .toolbar .icon { @apply stroke-2 text-xl; }

  .mobile-menu-nav-closed { @apply h-0 opacity-0; }
  .mobile-menu-nav-opened { @apply opacity-100; height: calc(var(--navCount) * 52px); }

  .mobile-menu-nav li a { @apply flex flex-row items-center justify-between; font-family: var(--primary-font); }

  /* Accordéon mobile */
details.mobile-dropdown > summary { /* ... */ }
details.mobile-dropdown > summary::-webkit-details-marker { display: none; }
details.mobile-dropdown[open] .rotate-indicator { transform: rotate(90deg); transition: transform .2s; }


  @keyframes nav-onload-animation {
    0% { transform: translateY(-5rem) translateX(-50%); opacity: 0; }
    100% { transform: translateY(0) translateX(-50%); opacity: 1; }
  }

  /* Halo & glitch (inchangés) */
  .nav {
    --halo: var(--primary-color);
    border-radius: 16px;
    background-clip: padding-box;
    box-shadow:
      0 0 0 1px rgba(66, 151, 207, 0.55),
      0 0 12px rgba(102, 170, 255, 0.50),
      0 0 28px rgba(122, 25, 160, 0.35),
      6px 0 18px rgba(0, 195, 255, 0.55),
      -6px 0 18px rgba(255, 0, 242, 0.45);
  }
  .nav:hover, .nav:focus-within {
    box-shadow:
      0 0 0 1px rgba(102, 170, 255, 0.65),
      0 0 14px rgba(102, 170, 255, 0.60),
      0 0 34px rgba(102, 170, 255, 0.45),
      7px 0 20px rgba(0, 195, 255, 0.65),
      -7px 0 20px rgba(255, 0, 242, 0.55);
  }
  .nav { backdrop-filter: blur(6px); z-index: 9999999; }

  .brand-lg .title { position: relative; display: flex; align-items: center; }
   .title{overflow: visible !important;}
</style>

<script>
  /* (script d’origine inchangé) */
  const reinitializeIcon = (icon) => {
    const cloned = icon.cloneNode(true);
    icon.parentNode?.replaceChild(cloned, icon);
    return cloned;
  };

  const menuSwitcher = document.getElementById("menu-switcher");
  const mobileMenuNav = document.getElementById("mobile-menu-nav");
  const mobileMenuNavItems = document.getElementsByClassName("mobile-nav-item");
  let menuIconClosed = document.getElementById("menu-icon-closed");
  let menuIconOpened = document.getElementById("menu-icon-opened");
  let isMenuOpen = false;

  const switchMenuState = () => {
    menuIconClosed.style.display = isMenuOpen ? "block" : "none";
    menuIconOpened.style.display = !isMenuOpen ? "block" : "none";
    if (isMenuOpen) menuIconClosed = reinitializeIcon(menuIconClosed);
    else menuIconOpened = reinitializeIcon(menuIconOpened);
    if (isMenuOpen) {
      mobileMenuNav.classList.replace("mobile-menu-nav-opened","mobile-menu-nav-closed");
    } else {
      mobileMenuNav.classList.replace("mobile-menu-nav-closed","mobile-menu-nav-opened");
    }
    isMenuOpen = !isMenuOpen;
  };

  menuSwitcher.addEventListener("click", switchMenuState);
  for (let i = 0; i < mobileMenuNavItems.length; ++i) {
    mobileMenuNavItems.item(i)?.addEventListener("click", switchMenuState);
  }
  document.addEventListener("click", (event) => {
    if (!menuSwitcher.contains(event.target) && !mobileMenuNav.contains(event.target) && isMenuOpen) {
      switchMenuState();
    }
  });

  const themeSwitcher = document.getElementById("theme-switcher");
  let themeIconLight = document.getElementById("theme-icon-light");
  let themeIconDark = document.getElementById("theme-icon-dark");
  let currentTheme = localStorage.getItem("theme") || "light";

  const setTheme = (theme) => {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
    currentTheme = theme;
    themeIconDark.style.display = theme === "dark" ? "block" : "none";
    themeIconLight.style.display = theme === "light" ? "block" : "none";
    if (theme === "dark") themeIconDark = reinitializeIcon(themeIconDark);
    else themeIconLight = reinitializeIcon(themeIconLight);
    document.documentElement.classList.toggle("dark", theme === "dark");
  };

  themeSwitcher.addEventListener("click", () => {
    setTheme(currentTheme === "light" ? "dark" : "light");
  });

  document.addEventListener("DOMContentLoaded", () => {
    setTheme(currentTheme);
    menuIconClosed.style.display = "block";
  });

  const navBarElement = document.getElementById("nav");
  const bannerElement = document.getElementById("p5-holder");
  const bannerHeight = bannerElement?.offsetHeight ? (bannerElement.offsetHeight - 50) : 200;
  let lastYPos = 0;
  window.addEventListener("scroll", () => {
    if (bannerHeight < window.scrollY && window.scrollY > lastYPos) {
      navBarElement.style.top = "-72px";
    } else {
      navBarElement.style.top = "0";
    }
    lastYPos = window.scrollY;
  });
</script>
