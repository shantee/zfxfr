---
export interface Props {
  lat?: number; lng?: number; zoom?: number;

  // ✅ nouveaux réglages
  minZoom?: number; maxZoom?: number;
  scrollWheelZoom?: boolean;      // zoom molette (si clickToWheelZoom = false)
  clickToWheelZoom?: boolean;     // molette active seulement après clic

  radiusKm?: number; popup?: string;
  marker?: boolean; circle?: boolean;
  class?: string; style?: string;
  height?: number; heightMd?: number; heightLg?: number;
}

const {
  lat = 47.64, lng = 6.12, zoom = 2,

  // ✅ defaults : ne change rien tant que tu ne passes pas les props
  minZoom = 0, maxZoom = 20,
  scrollWheelZoom = true,
  clickToWheelZoom = false,

  radiusKm = 15, popup = "Interventions autour de Vesoul",
  marker = true, circle = true,
  class: klass = "", style,
  height = 360, heightMd = 420, heightLg = 480,
} = Astro.props;
---

<div data-map-root>
  <div
    class={`leaflet-map rounded-2xl overflow-hidden ${klass}`}
    style={`--h:${height}px;--h-md:${heightMd}px;--h-lg:${heightLg}px;${style ?? ""}`}
    data-lat={String(lat)} data-lng={String(lng)} data-zoom={String(zoom)}
    data-min-zoom={String(minZoom)} data-max-zoom={String(maxZoom)}
    data-scroll-wheel-zoom={scrollWheelZoom ? "true" : "false"}
    data-click-to-wheel-zoom={clickToWheelZoom ? "true" : "false"}
    data-radius-km={String(radiusKm)} data-popup={popup}
    data-marker={marker ? "true" : "false"}
    data-circle={circle ? "true" : "false"}
  ></div>

  <noscript>
    <a href={`https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=${zoom}/${lat}/${lng}`} target="_blank" rel="noopener">
      Voir la carte (nécessite JavaScript)
    </a>
  </noscript>

  <script is:inline>
  (function () {
    const root = document.currentScript.closest('[data-map-root]');
    if (!root) return;
    const el = root.querySelector('.leaflet-map');
    if (!el) return;

    // Injecte Leaflet CSS une seule fois
    if (!document.querySelector('link[data-leaflet]')) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      link.setAttribute('data-leaflet', '');
      document.head.appendChild(link);
    }

    function asNumber(v, fallback) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    }
    function asInt(v, fallback) {
      const n = parseInt(String(v ?? ''), 10);
      return Number.isFinite(n) ? n : fallback;
    }
    function asBool(v, fallback) {
      if (v == null) return fallback;
      const s = String(v).trim().toLowerCase();
      if (s === 'true' || s === '1' || s === 'yes' || s === 'on') return true;
      if (s === 'false' || s === '0' || s === 'no' || s === 'off') return false;
      return fallback;
    }

    function init() {
      const lat = asNumber(el.dataset.lat, 47.64);
      const lng = asNumber(el.dataset.lng, 6.12);
      const zoom = asInt(el.dataset.zoom, 2);

      const minZoom = asInt(el.dataset.minZoom, 0);
      const maxZoom = asInt(el.dataset.maxZoom, 20);

      const scrollWheelZoom = asBool(el.dataset.scrollWheelZoom, true);
      const clickToWheelZoom = asBool(el.dataset.clickToWheelZoom, false);

      const radiusKm = asNumber(el.dataset.radiusKm, 0);
      const showMarker = asBool(el.dataset.marker, true);
      const showCircle = asBool(el.dataset.circle, true);
      const popup = el.dataset.popup || '';

      // ✅ si clickToWheelZoom: on démarre molette OFF pour laisser la page défiler
      const map = L.map(el, {
        minZoom,
        maxZoom,
        scrollWheelZoom: clickToWheelZoom ? false : scrollWheelZoom,
      }).setView([lat, lng], zoom);

      // sécurité (au cas où)
      map.setMinZoom(minZoom);
      map.setMaxZoom(maxZoom);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        detectRetina: true,
        // attribution: '&copy; OpenStreetMap contributors',
      }).addTo(map);

      if (showMarker) {
        const m = L.marker([lat, lng]).addTo(map);
        if (popup) m.bindPopup(popup);
      }

      if (showCircle && radiusKm > 0) {
        L.circle([lat, lng], { radius: radiusKm * 1000, weight: 2, fillOpacity: 0.08 }).addTo(map);
      }

      // ✅ Molette active seulement après clic, et se coupe quand on sort de la carte
      if (clickToWheelZoom) {
        map.scrollWheelZoom.disable();
        map.on('click', () => map.scrollWheelZoom.enable());
        el.addEventListener('mouseleave', () => map.scrollWheelZoom.disable());
      }
    }

    // Charge Leaflet JS si nécessaire, puis init
    if (typeof window.L === 'undefined') {
      let s = document.querySelector('script[data-leaflet]');
      if (!s) {
        s = document.createElement('script');
        s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        s.defer = true;
        s.setAttribute('data-leaflet', '');
        s.onload = init;
        document.head.appendChild(s);
      } else {
        // si le script existe déjà, on init quand même (si déjà chargé => window.L existe et on passe dans le else)
        s.addEventListener('load', init, { once: true });
      }
    } else {
      init();
    }
  })();
  </script>
</div>

<style>
.leaflet-map { height: var(--h, 360px); }
@media (min-width: 768px)  { .leaflet-map { height: var(--h-md, 420px); } }
@media (min-width: 1024px) { .leaflet-map { height: var(--h-lg, 480px); } }
</style>
