---
export interface Props {
  lat?: number; lng?: number; zoom?: number;

  // ‚úÖ nouveaux r√©glages
  minZoom?: number; maxZoom?: number;
  scrollWheelZoom?: boolean;      // zoom molette (si clickToWheelZoom = false)
  clickToWheelZoom?: boolean;     // molette active seulement apr√®s clic

  radiusKm?: number; popup?: string;
  marker?: boolean; circle?: boolean;
  class?: string; style?: string;
  height?: number; heightMd?: number; heightLg?: number;
  
  // üöÄ Optimisation : Image affich√©e avant le chargement (capture d'√©cran)
  placeholderImg?: string;
}

const {
  lat = 47.64, lng = 6.12, zoom = 2,

  // ‚úÖ defaults
  minZoom = 0, maxZoom = 20,
  scrollWheelZoom = true,
  clickToWheelZoom = false,

  radiusKm = 15, popup = "Interventions autour de Vesoul",
  marker = true, circle = true,
  class: klass = "", style,
  height = 360, heightMd = 420, heightLg = 480,
  
  // Image par d√©faut ou vide (si vide, fond gris)
  placeholderImg = "" 
} = Astro.props;

// Construction du style pour l'image de placeholder
const bgStyle = placeholderImg ? `background-image: url('${placeholderImg}'); background-size: cover; background-position: center;` : 'background-color: #e5e7eb;';
---

<div data-map-root class="relative group">
  <div
    class={`leaflet-map rounded-2xl overflow-hidden ${klass}`}
    style={`--h:${height}px;--h-md:${heightMd}px;--h-lg:${heightLg}px; ${bgStyle} ${style ?? ""}`}
    data-lat={String(lat)} data-lng={String(lng)} data-zoom={String(zoom)}
    data-min-zoom={String(minZoom)} data-max-zoom={String(maxZoom)}
    data-scroll-wheel-zoom={scrollWheelZoom ? "true" : "false"}
    data-click-to-wheel-zoom={clickToWheelZoom ? "true" : "false"}
    data-radius-km={String(radiusKm)} data-popup={popup}
    data-marker={marker ? "true" : "false"}
    data-circle={circle ? "true" : "false"}
  >
  <div class="map-loading-indicator w-full h-full flex items-center justify-center text-gray-800 font-medium text-sm bg-white/60 backdrop-blur-sm">
    Chargement de la carte...
</div>
  </div>

  <noscript>
    <a href={`https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=${zoom}/${lat}/${lng}`} target="_blank" rel="noopener" class="block p-4 text-center underline">
      Voir la carte (n√©cessite JavaScript)
    </a>
  </noscript>

  <script is:inline>
  (function () {
    const root = document.currentScript.closest('[data-map-root]');
    if (!root) return;
    const el = root.querySelector('.leaflet-map');
    if (!el) return;

    // Helpers de conversion
    function asNumber(v, fallback) { const n = Number(v); return Number.isFinite(n) ? n : fallback; }
    function asInt(v, fallback) { const n = parseInt(String(v ?? ''), 10); return Number.isFinite(n) ? n : fallback; }
    function asBool(v, fallback) {
      if (v == null) return fallback;
      const s = String(v).trim().toLowerCase();
      if (s === 'true' || s === '1' || s === 'yes' || s === 'on') return true;
      if (s === 'false' || s === '0' || s === 'no' || s === 'off') return false;
      return fallback;
    }

    // 1. Initialisation r√©elle de la carte (lanc√©e apr√®s chargement des scripts)
    function initMap() {
      // Nettoyage de l'indicateur de chargement visuel
      const loader = el.querySelector('.map-loading-indicator');
      if(loader) loader.remove();

      const lat = asNumber(el.dataset.lat, 47.64);
      const lng = asNumber(el.dataset.lng, 6.12);
      const zoom = asInt(el.dataset.zoom, 2);
      const minZoom = asInt(el.dataset.minZoom, 0);
      const maxZoom = asInt(el.dataset.maxZoom, 20);
      const scrollWheelZoom = asBool(el.dataset.scrollWheelZoom, true);
      const clickToWheelZoom = asBool(el.dataset.clickToWheelZoom, false);
      const radiusKm = asNumber(el.dataset.radiusKm, 0);
      const showMarker = asBool(el.dataset.marker, true);
      const showCircle = asBool(el.dataset.circle, true);
      const popup = el.dataset.popup || '';

      const map = L.map(el, {
        minZoom,
        maxZoom,
        scrollWheelZoom: clickToWheelZoom ? false : scrollWheelZoom,
      }).setView([lat, lng], zoom);

      map.setMinZoom(minZoom);
      map.setMaxZoom(maxZoom);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        detectRetina: true,
        attribution: '',
      }).addTo(map);

      if (showMarker) {
        const m = L.marker([lat, lng]).addTo(map);
        if (popup) m.bindPopup(popup);
      }

      if (showCircle && radiusKm > 0) {
        L.circle([lat, lng], { radius: radiusKm * 1000, weight: 2, fillOpacity: 0.08 }).addTo(map);
      }

      if (clickToWheelZoom) {
        map.scrollWheelZoom.disable();
        map.on('click', () => map.scrollWheelZoom.enable());
        el.addEventListener('mouseleave', () => map.scrollWheelZoom.disable());
      }
    }

    // 2. Fonction pour charger les ressources (CSS/JS)
    function loadResources() {
      // Injecte CSS si absent
      if (!document.querySelector('link[data-leaflet]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/scripts/leaflet.css';
        link.setAttribute('data-leaflet', '');
        document.head.appendChild(link);
      }

      // Gestion du Script JS
      if (typeof window.L === 'undefined') {
        let s = document.querySelector('script[data-leaflet]');
        if (!s) {
          s = document.createElement('script');
          s.src = '/scripts/leaflet.js';
          s.defer = true;
          s.setAttribute('data-leaflet', '');
          // Une fois charg√©, on init
          s.onload = initMap;
          document.head.appendChild(s);
        } else {
          // Script d√©j√† en cours de chargement ailleurs
          s.addEventListener('load', initMap);
        }
      } else {
        // D√©j√† charg√©
        initMap();
      }
    }

    // 3. Intersection Observer : ne d√©clenche loadResources que si visible
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          loadResources();
          observer.disconnect(); // On arr√™te d'observer une fois lanc√©
        }
      });
    }, { 
      rootMargin: "200px" // Charge 200px avant que l'√©l√©ment n'arrive √† l'√©cran
    });

    observer.observe(el);

  })();
  </script>
</div>

<style>
.leaflet-map { height: var(--h, 360px); }
@media (min-width: 768px)  { .leaflet-map { height: var(--h-md, 420px); } }
@media (min-width: 1024px) { .leaflet-map { height: var(--h-lg, 480px); } }

/* Transition douce pour cacher le loader quand le canvas leaflet arrive par dessus */
.leaflet-container { z-index: 10; } 
</style>